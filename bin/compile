#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

echo "==> Buildpack - Get latest git tag"

BUILD_DIR="$1"
CACHE_DIR="$2"
ENV_DIR="$3"

APP_VERSION=$(git describe --tags --abbrev=0)

SOURCE_PROFILE_PATH="$BUILD_DIR/.profile.d/git-sha.sh"
APP_PROFILE_PATH="$BUILD_DIR/.profile.d/app-version.sh"

create_env() {
  # populate profile.d
  mkdir -p $(dirname $SOURCE_PROFILE_PATH)
  mkdir -p $(dirname $APP_PROFILE_PATH)
}

write_source_version_profile() {
  echo "=====> Writing SOURCE_VERSION ($SOURCE_VERSION) to $SOURCE_PROFILE_PATH"
  echo "export GIT_SHA=\"$SOURCE_VERSION\"" >> $SOURCE_PROFILE_PATH
}

write_tag_version_profile() {
  echo "=====> Writing APP_VERSION ($APP_VERSION) to $APP_PROFILE_PATH"
  echo "export APP_VERSION=\"$APP_VERSION\"" >> $APP_PROFILE_PATH
}

create_env
write_source_version_profile
write_tag_version_profile

exit 0
